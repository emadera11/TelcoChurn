---
title: "Customer Churn Analysis"
output: 
    html_document:
        smart: false
---

<h3>What is Customer Churn?</h3>
Simply put, customer churn occurs when customers or subscribers stop doing business with a company or service. Also known as customer attrition, customer churn is a critical metric because it is much less expensive to retain existing customers than it is to acquire new customers – earning business from new customers means working leads all the way through the sales funnel, utilizing your marketing and sales resources throughout the process. Customer retention, on the other hand, is generally more cost-effective as you’ve already earned the trust and loyalty of existing customers.

Customer churn impedes growth, so companies should have a defined method for calculating customer churn in a given period of time. By being aware of and monitoring churn rate, organizations are equipped to determine their customer retention success rates and identify strategies for improvement.


Loading the necessary pacakges for this analysis: 

```{r messages=FALSE}

library(dplyr)
library(psych)
library(tidyr)
library(ggplot2)
library(rpart)
library(rpart.plot)
library(caTools)
library(randomForest)
library(knitr)
library(rmarkdown)
library(kableExtra)
library(gridExtra)
library(corrplot)


```
For this analysis i will predict customer churn using Logistic Regression, Decision Tree and Random Forest.   Data background information: 
THe data contains customer information such as if the customer is senior citizen, which product are they current enroll, 
monthly charges and total charges, amoung other variables that might be important for our prediction.  

The below tables contains information on what is stored in each variable.  This gives us the ability to guage 
on what the content of the data.   

```{r echo=FALSE} 
options(knitr.table.format = "html")
df  = read.csv("D:\\Emman\\Documents\\GitHub\\TelcoChurn\\ChurnAnalysis\\ChurnAnalysis\\datasource\\customerchurn.csv", na.strings = c("", "NA"))

kable(head(df)) %>%
     kable_styling(bootstrap_options = "striped",
                full_width = F) %>%
             scroll_box(width='100%')

```


Below table shows the description of each variable.    before we move further to clean the data and prepare the data for our models 
lets explore the data.   Below I used the summary function to describe the contents of the data.


```{r}
summary(df)                                                                  
```

<h2>Data Visualization and Exploration</h2>

The below Histograms represent the distribution of the MonthlyCHarges, TotalCharges and Tenure.  

<ul>
    <li>MonthlyCharges: The distribution for this data as we can visualize it does not come from a normal distirbution.  We can do a statistical test and hypothize the normality of the data. </li></br>
    <li>TotalCharges: This data is heavily right skewed we can conclude that this data does not come from a normal distribution.</li></br>
    <li>Tenure: This data does not come from a normal distribution. We can perform a statistical analysis to determine the normality of this data. </li>

</ul>

```{r fig.width=20, fig.height=7}

a = ggplot(df, aes(MonthlyCharges)) +
    geom_histogram(color = "black", fill = "red", binwidth = 15, alpha = 0.5) +
    theme_bw()

b = ggplot(df, aes(TotalCharges)) +
    geom_histogram(color = "black", fill = "blue", alpha = 0.5, binwidth = 500) +
    theme_bw()

c = ggplot(df, aes(tenure)) +
    geom_histogram(color = "black", fill = "green", alpha = 0.5, binwidth = 5) +
    theme_bw()

grid.arrange(a, b, c, ncol=3)
```

```{r}
```


The below chart shows the averages Total Monthly Charges by Tenure and Contract.  
As we can see Month to Month and one Year contract have a strong linear corralation .  For the two year Contract
There is a strong linear corralation but is not as strong as the other two contracts.  As the tenure months increase the average monthly charges tends to increase as well. 

The boxplot shows that the average for monthly charges are closed for being equal.  We can use analysis of anavo to test the hypothesis that the mean are equal for the contracts.  
Boxplot are also used to detect outliers from the boxplot below it appears that there aren't any visible outliers.  I will perform a statistical analysis for outlier detection.

```{r fig.width=20, fig.height=7} 
d = df %>% group_by(Contract, tenure) %>%
    summarise(AvgMonthly = mean(MonthlyCharges)) %>%
    ggplot(aes(tenure, AvgMonthly, color = Contract)) + #, group = Contract)) +
    geom_point(size=3) +
    ggtitle("Average Monthly Charges By Tenure") +
    theme_bw()

e = ggplot(df, aes(factor(Contract), MonthlyCharges, fill = factor(Contract))) +
    geom_boxplot() +
    theme_bw() +
    ggtitle("Boxplot for Contract nd Monthly Charges")

grid.arrange(d, e, ncol = 2)

```
<h2>Data Cleansing</h2> 

Data cleansing is a big part in any data analytics project.  The cleansing will allow us to standardize the data and prepare the data for modeling.   
we have noticed that the there are several features that contains the following: 
<ul> 
    <li>No Internet Service </li>
    <li> No Phone Service </li> 
</ul>

These features contains other data such as Yes and No, We will normalize the data to just have a Yes and no.  the below loop will look for those feature and transform them.  
```{r}
for (i in names(df)) {
    if (is.factor(df[, i]) == TRUE) {
        df[, i] = as.factor(ifelse(as.character(df[, i]) == "No internet service" | as.character(df[, i]) == "No phone service", "No", as.character(df[, i])))

    }
}

df$InternetService = as.factor(ifelse(as.character(df$InternetService) == "DSL" | as.character(df$InternetService) == "Fiber optic", "Yes", as.character(df$InternetService)))

summary(df)

for(i in colnames(df)) {
    if (is.numeric(df[, i])) {
        df[, i] = ifelse(is.na(df[, i]), mean(df[, i], na.rm = TRUE), df[, i])
    }
}

df$Churn = ifelse(df$Churn == "Yes", 1, 0)

b = df %>% select(-customerID)

indx <- sapply(b, is.factor)
b[indx] <- lapply(b[indx], function(x) as.numeric((x)))

head(b)

c = cor(b)
corrplot(c, method = 'circle')
```